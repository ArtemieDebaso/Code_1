{% extends "layout.html" %}

{% block title %}Создание теста{% endblock %}

{% block content %}
<div class="row">
    <!-- Боковое меню -->
    <div class="col-md-3 sidebar">
        <h4 class="mb-3">Панель преподавателя</h4>
        <div class="nav flex-column nav-pills">
            <a class="nav-link" href="/teacher/dashboard">
                <i class="bi bi-speedometer2 me-2"></i>Обзор
            </a>
            <a class="nav-link active" href="/teacher/tests">
                <i class="bi bi-journal-text me-2"></i>Мои тесты
            </a>
            <a class="nav-link" href="/teacher/analytics">
                <i class="bi bi-bar-chart me-2"></i>Аналитика
            </a>
            <a class="nav-link" href="/teacher/assign">
                <i class="bi bi-person-check me-2"></i>Назначить тест
            </a>
        </div>
    </div>
    
    <!-- Основной контент -->
    <div class="col-md-9">
        <div class="page-title d-flex justify-content-between align-items-center">
            <h2><i class="bi bi-plus-circle me-2"></i>Создание нового теста</h2>
            <a href="/teacher/tests" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left me-2"></i>Назад к тестам
            </a>
        </div>
        
        <div class="alert alert-info mb-4">
            <i class="bi bi-info-circle-fill me-2"></i>
            <span>Заполните информацию о тесте, добавьте вопросы и варианты ответов. После сохранения тест будет доступен для назначения студентам.</span>
        </div>
        
        <form id="create-test-form" action="/api/tests/create" method="post">
            <!-- Основная информация о тесте -->
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Основная информация</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-12">
                            <label for="test_title" class="form-label">Название теста</label>
                            <input type="text" class="form-control" id="test_title" name="title" required>
                        </div>
                        <div class="col-md-12">
                            <label for="test_description" class="form-label">Описание теста</label>
                            <textarea class="form-control" id="test_description" name="description" rows="3"></textarea>
                        </div>
                        <div class="col-md-4">
                            <label for="test_time_limit" class="form-label">Ограничение времени (мин.)</label>
                            <input type="number" class="form-control" id="test_time_limit" name="time_limit" value="30" min="5" max="180">
                        </div>
                        <div class="col-md-4">
                            <label for="test_passing_score" class="form-label">Проходной балл (%)</label>
                            <input type="number" class="form-control" id="test_passing_score" name="passing_score" value="70" min="0" max="100">
                        </div>
                        <div class="col-md-4">
                            <label for="test_status" class="form-label">Статус теста</label>
                            <select class="form-select" id="test_status" name="status">
                                <option value="draft">Черновик</option>
                                <option value="published">Опубликован</option>
                                <option value="archived">Архив</option>
                            </select>
                        </div>
                        <!-- Скрытое поле для данных вопросов -->
                        <input type="hidden" id="questions_data" name="questions_data" value="[]">
                    </div>
                </div>
            </div>
            
            <!-- Вопросы теста -->
            <div class="card mb-4">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Вопросы теста</h5>
                    <button type="button" class="btn btn-primary btn-sm" id="add-question-btn">
                        <i class="bi bi-plus me-1"></i>Добавить вопрос
                    </button>
                </div>
                <div class="card-body" id="questions-container">
                    <div class="alert alert-secondary" id="no-questions-alert">
                        <i class="bi bi-exclamation-circle me-2"></i>
                        <span>Вопросы еще не добавлены. Нажмите кнопку "Добавить вопрос".</span>
                    </div>
                    
                    <!-- Шаблон вопроса (будет клонироваться JavaScript'ом) -->
                    <div class="question-template d-none">
                        <div class="question-item card mb-3">
                            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">Вопрос <span class="question-number"></span></h6>
                                <div>
                                    <button type="button" class="btn btn-outline-danger btn-sm remove-question-btn">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="row g-3">
                                    <div class="col-md-12">
                                        <label class="form-label">Текст вопроса</label>
                                        <textarea class="form-control question-text" rows="2" required></textarea>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Тип вопроса</label>
                                        <select class="form-select question-type">
                                            <option value="single">Один вариант ответа</option>
                                            <option value="multiple">Несколько вариантов ответа</option>
                                            <option value="text">Текстовый ответ</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Баллы за вопрос</label>
                                        <input type="number" class="form-control question-points" value="1" min="1" max="100">
                                    </div>
                                </div>
                                
                                <div class="options-container mt-3">
                                    <h6 class="border-bottom pb-2 mb-3 d-flex justify-content-between align-items-center">
                                        <span>Варианты ответов</span>
                                        <div>
                                            <button type="button" class="btn btn-sm btn-outline-secondary me-2 set-all-one-btn">
                                                <i class="bi bi-1-circle me-1"></i>Всё по одному
                                            </button>
                                            <button type="button" class="btn btn-sm btn-outline-primary add-option-btn">
                                                <i class="bi bi-plus-circle me-1"></i>Добавить вариант
                                            </button>
                                        </div>
                                    </h6>
                                    
                                    <div class="options-list">
                                        <div class="option-item row g-2 mb-2">
                                            <div class="col-md-8">
                                                <input type="text" class="form-control option-text" placeholder="Вариант ответа" required>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="form-check mt-2">
                                                    <input class="form-check-input correct-option" type="checkbox" value="1">
                                                    <label class="form-check-label">Правильный ответ</label>
                                                </div>
                                            </div>
                                            <div class="col-md-1">
                                                <button type="button" class="btn btn-outline-danger btn-sm remove-option-btn">
                                                    <i class="bi bi-x"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="text-answer-container mt-3 d-none">
                                    <h6 class="border-bottom pb-2 mb-3">Правильный ответ</h6>
                                    <div class="row g-2">
                                        <div class="col-md-12">
                                            <input type="text" class="form-control correct-answer" placeholder="Введите правильный ответ">
                                            <div class="form-text">Укажите точный ответ, который должен ввести студент. Регистр не учитывается.</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Кнопки действий -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <button type="button" class="btn btn-secondary" onclick="location.href='/teacher/tests'">
                            <i class="bi bi-x-circle me-2"></i>Отмена
                        </button>
                        <div>
                            <button type="button" id="preview-test-btn" class="btn btn-outline-primary me-2">
                                <i class="bi bi-eye me-2"></i>Предпросмотр
                            </button>
                            <button type="button" id="save-test-btn" class="btn btn-primary">
                                <i class="bi bi-check-circle me-2"></i>Сохранить тест
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Модальное окно предпросмотра -->
<div class="modal fade" id="previewModal" tabindex="-1" aria-labelledby="previewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="previewModalLabel">Предпросмотр теста</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="preview-content">
                <!-- Здесь будет содержимое предпросмотра -->
            </div>
            <div class="modal-footer">
                <button type="button" id="expand-all-answers-btn" class="btn btn-outline-primary me-auto">
                    <i class="bi bi-arrows-expand me-2"></i>Развернуть все ответы
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Переменные для хранения состояния формы
        let currentQuestionIndex = 0;
        const previewModal = new bootstrap.Modal(document.getElementById('previewModal'));
        
        // Обработчик для формы создания теста
        document.getElementById('create-test-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Валидация перед отправкой
            if (!validateForm()) {
                return;
            }
            
            // Собираем данные формы
            const testData = collectFormData();
            
            // Устанавливаем данные в скрытое поле и отправляем форму
            document.getElementById('questions_data').value = JSON.stringify(testData.questions);
            console.log('Отправка данных теста:', testData);
            
            // Выполняем AJAX-запрос вместо отправки формы
            fetch('/api/tests/create', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(testData)
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(data => {
                        throw new Error(data.message || 'Ошибка при создании теста');
                    });
                }
                return response.json();
            })
            .then(data => {
                console.log('Тест успешно создан:', data);
                alert('Тест успешно создан!');
                window.location.href = '/teacher/tests';
            })
            .catch(error => {
                console.error('Ошибка:', error);
                alert('Произошла ошибка: ' + error.message);
            });
        });
        
        // Обработчик для кнопки сохранения
        document.getElementById('save-test-btn').addEventListener('click', function() {
            document.getElementById('create-test-form').dispatchEvent(new Event('submit'));
        });
        
        // Обработчик для кнопки предпросмотра
        document.getElementById('preview-test-btn').addEventListener('click', function() {
            const testData = collectFormData();
            if (!validateForm()) {
                return;
            }
            
            // Генерируем HTML для предпросмотра
            const previewContent = generatePreviewHTML(testData);
            document.getElementById('preview-content').innerHTML = previewContent;
            
            // Открываем модальное окно
            previewModal.show();
        });
        
        // Функция для сбора данных формы
        function collectFormData() {
            const form = document.getElementById('create-test-form');
            const questions = [];
            
            // Собираем основные данные теста
            const testData = {
                title: form.querySelector('#test_title').value.trim(),
                description: form.querySelector('#test_description').value.trim(),
                time_limit: parseInt(form.querySelector('#test_time_limit').value) || 30,
                passing_score: parseInt(form.querySelector('#test_passing_score').value) || 70,
                status: form.querySelector('#test_status').value,
                questions: []
            };
            
            // Собираем данные вопросов
            document.querySelectorAll('.question-item:not(.d-none)').forEach((item, index) => {
                const questionText = item.querySelector('.question-text').value.trim();
                const questionType = item.querySelector('.question-type').value;
                const questionPoints = parseInt(item.querySelector('.question-points').value) || 1;
                
                const question = {
                    id: `q${index+1}`,
                    text: questionText,
                    type: questionType,
                    points: questionPoints
                };
                
                if (questionType !== 'text') {
                    // Обработка вопросов с вариантами
                    question.options = [];
                    item.querySelectorAll('.option-item').forEach((optItem) => {
                        const optionText = optItem.querySelector('.option-text').value.trim();
                        const isCorrect = optItem.querySelector('.correct-option').checked;
                        
                        if (optionText) {
                            question.options.push({
                                text: optionText,
                                is_correct: isCorrect
                            });
                        }
                    });
                } else {
                    // Обработка текстовых вопросов
                    question.correct_answer = item.querySelector('.correct-answer').value.trim();
                }
                
                testData.questions.push(question);
            });
            
            return testData;
        }
        
        // Функция валидации формы
        function validateForm() {
            const form = document.getElementById('create-test-form');
            const title = form.querySelector('#test_title').value.trim();
            
            if (!title) {
                alert('Введите название теста');
                form.querySelector('#test_title').focus();
                return false;
            }
            
            const questions = document.querySelectorAll('.question-item:not(.d-none)');
            if (questions.length === 0) {
                alert('Добавьте хотя бы один вопрос');
                return false;
            }
            
            // Проверяем каждый вопрос
            let isValid = true;
            questions.forEach((item, index) => {
                const questionText = item.querySelector('.question-text').value.trim();
                const questionType = item.querySelector('.question-type').value;
                
                if (!questionText) {
                    alert(`Вопрос ${index + 1}: введите текст вопроса`);
                    isValid = false;
                    return;
                }
                
                if (questionType !== 'text') {
                    // Проверка для вопросов с вариантами
                    const options = item.querySelectorAll('.option-item');
                    if (options.length < 2) {
                        alert(`Вопрос ${index + 1}: добавьте не менее двух вариантов ответа`);
                        isValid = false;
                        return;
                    }
                    
                    // Проверка наличия правильного ответа
                    let hasCorrectOption = false;
                    options.forEach(option => {
                        if (option.querySelector('.correct-option').checked) {
                            hasCorrectOption = true;
                        }
                    });
                    
                    if (!hasCorrectOption) {
                        alert(`Вопрос ${index + 1}: отметьте хотя бы один правильный ответ`);
                        isValid = false;
                        return;
                    }
                } else {
                    // Проверка для текстовых вопросов
                    const correctAnswer = item.querySelector('.correct-answer').value.trim();
                    if (!correctAnswer) {
                        alert(`Вопрос ${index + 1}: введите правильный ответ`);
                        isValid = false;
                        return;
                    }
                }
            });
            
            return isValid;
        }
        
        // Функция генерации HTML для предпросмотра
        function generatePreviewHTML(testData) {
            let html = `
                <div class="preview-test">
                    <h4>${testData.title}</h4>
                    <p class="text-muted">${testData.description || 'Без описания'}</p>
                    <p><strong>Время на выполнение:</strong> ${testData.time_limit} минут</p>
                    <p><strong>Проходной балл:</strong> ${testData.passing_score}%</p>
                    <hr>
                    <h5>Вопросы теста:</h5>
                    <div class="preview-questions">
            `;
            
            testData.questions.forEach((question, index) => {
                html += `
                    <div class="preview-question mb-4">
                        <h6>${index + 1}. ${question.text} <span class="badge bg-secondary">${question.points} ${getPointsLabel(question.points)}</span></h6>
                `;
                
                if (question.type === 'single') {
                    html += `<p class="text-muted">Выберите один вариант ответа:</p>
                    <div class="answer-options" style="display: none;">`;
                    question.options.forEach((option, optIdx) => {
                        html += `
                            <div class="form-check">
                                <input class="form-check-input" type="radio" disabled>
                                <label class="form-check-label${option.is_correct ? ' text-success fw-bold' : ''}">
                                    ${option.text} ${option.is_correct ? ' ✓' : ''}
                                </label>
                            </div>
                        `;
                    });
                    html += `</div>`;
                } else if (question.type === 'multiple') {
                    html += `<p class="text-muted">Выберите все правильные варианты:</p>
                    <div class="answer-options" style="display: none;">`;
                    question.options.forEach((option, optIdx) => {
                        html += `
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" disabled>
                                <label class="form-check-label${option.is_correct ? ' text-success fw-bold' : ''}">
                                    ${option.text} ${option.is_correct ? ' ✓' : ''}
                                </label>
                            </div>
                        `;
                    });
                    html += `</div>`;
                } else if (question.type === 'text') {
                    html += `
                        <p class="text-muted">Введите ответ:</p>
                        <input type="text" class="form-control" disabled>
                        <div class="answer-options" style="display: none;">
                            <p class="text-success mt-2"><small><strong>Правильный ответ:</strong> ${question.correct_answer}</small></p>
                        </div>
                    `;
                }
                
                html += `</div>`;
            });
            
            html += `</div></div>`;
            
            return html;
        }
        
        // Вспомогательная функция для склонения баллов
        function getPointsLabel(points) {
            if (points % 10 === 1 && points % 100 !== 11) {
                return 'балл';
            } else if ([2, 3, 4].includes(points % 10) && ![12, 13, 14].includes(points % 100)) {
                return 'балла';
            } else {
                return 'баллов';
            }
        }
        
        // Добавление нового вопроса
        document.getElementById('add-question-btn').addEventListener('click', function() {
            // Клонируем шаблон вопроса
            const template = document.querySelector('.question-template .question-item').cloneNode(true);
            template.classList.remove('d-none');
            
            // Инициализируем новый вопрос
            initializeQuestion(template, currentQuestionIndex++);
            
            // Добавляем вопрос в контейнер
            document.getElementById('questions-container').appendChild(template);
            
            // Обновляем нумерацию
            updateQuestionNumbers();
        });
        
        // Функция инициализации нового вопроса
        function initializeQuestion(questionItem, index) {
            // Устанавливаем номер вопроса
            questionItem.querySelector('.question-number').textContent = index + 1;
            
            // Добавляем обработчики событий
            
            // 1. Удаление вопроса
            questionItem.querySelector('.remove-question-btn').addEventListener('click', function() {
                if (confirm('Вы уверены, что хотите удалить этот вопрос?')) {
                    questionItem.remove();
                    updateQuestionNumbers();
                }
            });
            
            // 2. Изменение типа вопроса
            questionItem.querySelector('.question-type').addEventListener('change', function() {
                const type = this.value;
                const optionsContainer = questionItem.querySelector('.options-container');
                const textAnswerContainer = questionItem.querySelector('.text-answer-container');
                
                if (type === 'text') {
                    optionsContainer.classList.add('d-none');
                    textAnswerContainer.classList.remove('d-none');
                } else {
                    optionsContainer.classList.remove('d-none');
                    textAnswerContainer.classList.add('d-none');
                    
                    // Настраиваем чекбоксы/радио в зависимости от типа
                    const correctOptions = questionItem.querySelectorAll('.correct-option');
                    correctOptions.forEach(option => {
                        if (type === 'single') {
                            option.type = 'radio';
                            option.name = `correct_option_${index}`;
                        } else {
                            option.type = 'checkbox';
                            option.name = `correct_option_${index}[]`;
                        }
                    });
                }
            });
            
            // 3. Добавление нового варианта ответа
            questionItem.querySelector('.add-option-btn').addEventListener('click', function() {
                const optionsList = questionItem.querySelector('.options-list');
                const optionTemplate = optionsList.querySelector('.option-item').cloneNode(true);
                
                // Очищаем значения и настраиваем новый вариант
                optionTemplate.querySelector('.option-text').value = '';
                optionTemplate.querySelector('.correct-option').checked = false;
                
                // Добавляем обработчик удаления
                optionTemplate.querySelector('.remove-option-btn').addEventListener('click', function() {
                    if (optionsList.querySelectorAll('.option-item').length > 1) {
                        optionTemplate.remove();
                    } else {
                        alert('Должен быть хотя бы один вариант ответа');
                    }
                });
                
                optionsList.appendChild(optionTemplate);
            });
            
            // 4. Удаление варианта ответа
            questionItem.querySelectorAll('.remove-option-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const optionsList = questionItem.querySelector('.options-list');
                    if (optionsList.querySelectorAll('.option-item').length > 1) {
                        this.closest('.option-item').remove();
                    } else {
                        alert('Должен быть хотя бы один вариант ответа');
                    }
                });
            });
        }
        
        // Функция обновления нумерации вопросов
        function updateQuestionNumbers() {
            const questions = document.querySelectorAll('.question-item:not(.d-none):not(.question-template .question-item)');
            questions.forEach((question, index) => {
                question.querySelector('.question-number').textContent = index + 1;
            });
            
            // Показываем/скрываем сообщение о том, что нет вопросов
            const noQuestionsAlert = document.getElementById('no-questions-alert');
            if (questions.length > 0) {
                noQuestionsAlert.classList.add('d-none');
            } else {
                noQuestionsAlert.classList.remove('d-none');
            }
        }
        
        // Добавляем первый вопрос по умолчанию
        document.getElementById('add-question-btn').click();
        });
        
        // Удаление вопроса
        function setupQuestionHandlers(questionItem) {
            // Обработчик для удаления вопроса
            questionItem.querySelector('.remove-question-btn').addEventListener('click', function() {
                if (confirm('Вы уверены, что хотите удалить этот вопрос?')) {
                    questionItem.remove();
                    updateQuestionNumbers();
                }
            });
            
            // Обработчик для изменения типа вопроса
            questionItem.querySelector('.question-type').addEventListener('change', function() {
                const optionsContainer = questionItem.querySelector('.options-container');
                const textAnswerContainer = questionItem.querySelector('.text-answer-container');
                
                if (this.value === 'text') {
                    optionsContainer.classList.add('d-none');
                    textAnswerContainer.classList.remove('d-none');
                } else {
                    optionsContainer.classList.remove('d-none');
                    textAnswerContainer.classList.add('d-none');
                    
                    // Обновляем тип выбора правильного ответа
                    const correctOptions = questionItem.querySelectorAll('.correct-option');
                    // Определяем индекс текущего вопроса
                    const qIndex = Array.from(document.querySelectorAll('.question-item:not(.d-none)')).indexOf(questionItem);
                    
                    correctOptions.forEach(option => {
                        if (this.value === 'single') {
                            option.type = 'radio';
                            option.name = `questions[${qIndex}][correct_option]`;
                        } else {
                            option.type = 'checkbox';
                            const optIndex = Array.from(questionItem.querySelectorAll('.option-item')).indexOf(option.closest('.option-item'));
                            option.name = `questions[${qIndex}][options][${optIndex}][is_correct]`;
                        }
                    });
                }
            });
            
            // Обработчик для добавления варианта ответа
            questionItem.querySelector('.add-option-btn').addEventListener('click', function() {
                const optionsList = questionItem.querySelector('.options-list');
                const optionTemplate = optionsList.querySelector('.option-item');
                const newOption = optionTemplate.cloneNode(true);
                
                // Очищаем значение нового варианта
                newOption.querySelector('input[type="text"]').value = '';
                newOption.querySelector('.correct-option').checked = false;
                
                // Добавляем обработчик для удаления
                newOption.querySelector('.remove-option-btn').addEventListener('click', function() {
                    newOption.remove();
                    updateQuestionNumbers();
                });
                
                optionsList.appendChild(newOption);
                updateQuestionNumbers();
            });
            
            // Добавляем обработчики для существующих кнопок удаления вариантов
            questionItem.querySelectorAll('.remove-option-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const optionItem = button.closest('.option-item');
                    const optionsList = optionItem.parentElement;
                    
                    if (optionsList.querySelectorAll('.option-item').length > 1) {
                        optionItem.remove();
                        updateQuestionNumbers();
                    } else {
                        alert('Должен быть хотя бы один вариант ответа.');
                    }
                });
            });
        }
        
        /* 
           Здесь был удален конфликтующий обработчик события submit
        */
                    
                    question.options = options;
                } else {
                    // Обработка текстовых вопросов
                    const correctAnswer = item.querySelector('input[name*="correct_answer"]').value.trim();
                    
                    if (!correctAnswer) {
                        isValid = false;
                        alert(`Вопрос ${index + 1}: введите правильный ответ`);
                        return;
                    }
                    
                    question.correct_answer = correctAnswer;
                }
                
                questions.push(question);
            });
            
            if (!isValid) return;
            
            // 3. Сохраняем вопросы и отправляем форму
            document.getElementById('questions_data').value = JSON.stringify(questions);
            console.log('Отправка данных:', {
                title: title,
                questions: questions
            });
            
            this.submit();
            
            questionItems.forEach((item, index) => {
                const questionType = item.querySelector('.question-type').value;
                const questionText = item.querySelector('input[name*="[text]"]').value.trim();
                const questionPoints = parseInt(item.querySelector('input[name*="[points]"]').value || 10);
                
                // Проверка текста вопроса
                if (!questionText) {
                    isValid = false;
                    alert(`Вопрос ${index + 1}: введите текст вопроса`);
                    return;
                }
                
                // Создаем объект вопроса
                let questionData = {
                    id: `q${index + 1}`,
                    text: questionText,
                    type: questionType,
                    points: questionPoints
                };
                
                if (questionType !== 'text') {
                    // Для вопросов с вариантами ответов
                    const correctOptions = item.querySelectorAll('.correct-option:checked');
                    if (correctOptions.length === 0) {
                        isValid = false;
                        alert(`В вопросе ${index + 1} не выбран правильный ответ.`);
                    }
                    
                    if (questionType === 'single' && correctOptions.length > 1) {
                        isValid = false;
                        alert(`В вопросе ${index + 1} выбрано более одного правильного ответа для вопроса с одним вариантом ответа.`);
                    }
                    
                    // Собираем варианты ответов
                    const optionItems = item.querySelectorAll('.option-item');
                    let options = [];
                    
                    optionItems.forEach((optionItem, optionIndex) => {
                        const optionText = optionItem.querySelector('input[type="text"]').value.trim();
                        const isCorrect = optionItem.querySelector('.correct-option').checked;
                        
                        // Проверка текста варианта ответа
                        if (!optionText) {
                            isValid = false;
                            alert(`В вопросе ${index + 1}, вариант ${optionIndex + 1}: введите текст варианта`);
                            return;
                        }
                        
                        options.push({
                            text: optionText,
                            is_correct: isCorrect
                        });
                    });
                    
                    questionData.options = options;
                } else {
                    // Для текстовых вопросов
                    const correctAnswer = item.querySelector('input[name*="[correct_answer]"]').value.trim();
                    if (!correctAnswer) {
                        isValid = false;
                        alert(`В вопросе ${index + 1} не указан правильный ответ.`);
                    }
                    
                    questionData.correct_answer = correctAnswer;
                }
                
                questionsData.push(questionData);
            });
            
            if (!isValid) {
                e.preventDefault();
                return false;
            }
            
            // Отладочный вывод
            console.log("Подготовлены данные вопросов для отправки:", questionsData);
            
            // Сохраняем данные вопросов в JSON в скрытом поле
            document.getElementById('questions_data').value = JSON.stringify(questionsData);
            
            console.log("Форма проверена и готова к отправке");
            console.log("ID формы:", document.getElementById('create-test-form').id);
            console.log("Метод отправки:", document.getElementById('create-test-form').method);
            console.log("URL отправки:", document.getElementById('create-test-form').action);
            console.log("Количество полей:", document.getElementById('create-test-form').elements.length);
            
            // Выводим все поля формы
            const formElements = document.getElementById('create-test-form').elements;
            for (let i = 0; i < formElements.length; i++) {
                if (formElements[i].name) {
                    console.log(`Поле ${i}: ${formElements[i].name} = ${formElements[i].value.substring(0, 30)}${formElements[i].value.length > 30 ? '...' : ''}`);
                }
            }
            
            // Добавляем обратную связь для пользователя
            alert("Форма готова к отправке. Нажмите OK для продолжения.");
            console.log("Отправка формы...");
            
            // Явно отправляем форму после всех проверок
            document.getElementById('create-test-form').submit();
            return true;
        });
        
        // Обработчик для кнопки "Развернуть все ответы"
        document.getElementById('expand-all-answers-btn').addEventListener('click', function() {
            const previewContent = document.getElementById('preview-content');
            const answerDivs = previewContent.querySelectorAll('.answer-options');
            
            answerDivs.forEach(function(answerDiv) {
                answerDiv.style.display = 'block';
            });
            
            // Показываем обратную связь
            const button = this;
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="bi bi-check-circle me-2"></i>Развернуто!';
            button.disabled = true;
            
            setTimeout(function() {
                button.innerHTML = originalText;
                button.disabled = false;
            }, 2000);
        });
        
        // Обработчик для кнопки "Всё по одному"
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('set-all-one-btn')) {
                const questionsContainer = document.getElementById('questions-container');
                const questionItems = questionsContainer.querySelectorAll('.question-item:not(.question-template)');
                
                questionItems.forEach(function(question) {
                    const pointsInput = question.querySelector('.question-points');
                    if (pointsInput) {
                        pointsInput.value = 1;
                    }
                });
                
                // Показываем уведомление пользователю
                const button = e.target;
                const originalText = button.innerHTML;
                button.innerHTML = '<i class="bi bi-check-circle me-1"></i>Выполнено!';
                button.classList.remove('btn-outline-secondary');
                button.classList.add('btn-success');
                
                setTimeout(function() {
                    button.innerHTML = originalText;
                    button.classList.remove('btn-success');
                    button.classList.add('btn-outline-secondary');
                }, 2000);
            }
        });

        // Добавляем первый вопрос при загрузке страницы
        document.getElementById('add-question-btn').click();
    });
</script>
{% endblock %}